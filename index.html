<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, shrink-to-fit=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="theme-color" content="#151529">

    <title>Groot FRP Planters - Pricing Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      :root {
          /* Semiâ€‘dark + offâ€‘light, high contrast */
          --bg-page: #e5e9f2;
          --bg-card: #f9fafb;
          --bg-header: linear-gradient(135deg, #2563eb, #60a5fa);
          --bg-section-top: #111827;
          --border-soft: rgba(148,163,184,0.4);
          --accent: #2563eb;
          --accent-soft: rgba(37,99,235,0.15);
          --accent-glow: rgba(37,99,235,0.40);
          --success: #16a34a;
          --danger: #dc2626;
          --text-main: #111827;
          --text-muted: #6b7280;
          --text-invert: #f9fafb;
      }

      * { box-sizing: border-box; }

      body {
          min-height: 100vh;
          margin: 0;
          background: var(--bg-page);
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          color: var(--text-main);
          padding: 20px;
      }

      /* MAIN CARD */
      .console {
          max-width: 1300px;
          margin: 0 auto;
          background: var(--bg-card);
          border-radius: 24px;
          border: 1px solid var(--border-soft);
          box-shadow: 0 18px 45px rgba(15,23,42,0.18);
          overflow: hidden;
      }

      /* HEADER */
      .console-header {
          background: var(--bg-header);
          padding: 20px 28px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: var(--text-invert);
      }

      .console-title {
          font-size: 1.6rem;
          font-weight: 800;
          margin: 0;
      }

      .status-live {
          display: inline-flex;
          align-items: center;
          gap: 10px;
          padding: 8px 16px;
          background: rgba(15,23,42,0.25);
          border-radius: 999px;
          font-size: 0.85rem;
          font-weight: 600;
      }

      .status-dot {
          width: 9px;
          height: 9px;
          border-radius: 50%;
          background: #22c55e;
      }

      /* SECTION WRAPPER */
      .section {
          border-top: 1px solid var(--border-soft);
      }

      .section-header {
          background: #111827;
          padding: 14px 24px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .section-title {
          color: var(--text-invert);
          font-size: 0.95rem;
          font-weight: 700;
          letter-spacing: 0.04em;
          text-transform: uppercase;
          margin: 0;
      }

      .section-subtitle {
          color: #9ca3af;
          font-size: 0.78rem;
          margin-top: 2px;
      }

      .section-badge {
          background: #1f2937;
          color: #e5e7eb;
          padding: 4px 12px;
          border-radius: 999px;
          font-size: 0.75rem;
          font-weight: 600;
      }

      /* SECTION BODY */
      .section-body {
          padding: 22px 24px 26px;
          background: var(--bg-card);
      }

      /* LABELS + INPUTS */
      .form-label {
          font-size: 0.82rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.06em;
          color: var(--text-muted);
          margin-bottom: 6px;
      }

      .form-control,
      .form-select {
          background: #ffffff;
          border-radius: 12px;
          border: 1px solid #d1d5db;
          padding: 10px 14px;
          font-size: 0.98rem;
          color: var(--text-main);
          transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }

      .form-control::placeholder {
          color: #9ca3af;
      }

      .form-control:focus,
      .form-select:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-glow);
      }

      /* TABLE */
      .items-table {
          background: #f3f4f6;
          border-radius: 16px;
          overflow: hidden;
          border: 1px solid var(--border-soft);
      }

      .items-table thead th {
          background: #e5e7eb;
          color: #374151;
          font-size: 0.78rem;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          padding: 12px 10px;
          border: none;
      }

      .items-table tbody td {
          padding: 10px;
          vertical-align: middle;
          border-color: #e5e7eb;
      }

      /* BUTTONS â€“ higher contrast & more padding */
      .btn-add-remove {
          min-width: 44px;
          height: 40px;
          border-radius: 999px;
          font-size: 0.85rem;
          font-weight: 600;
          border: none;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 0 14px;
      }

      .btn-add {
          background: var(--accent);
          color: #ffffff;
      }

      .btn-add:hover {
          background: #1d4ed8;
      }

      .btn-remove {
          background: var(--danger);
          color: #ffffff;
      }

      .btn-remove:hover {
          background: #b91c1c;
      }

      /* TOTAL CARDS */
      .grand-total-card,
      .base-total-card {
          border-radius: 18px;
          padding: 14px 18px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #ecfdf3;   /* soft green */
          border: 1px solid #bbf7d0;
      }

      .base-total-card {
          background: #eff6ff;   /* soft blue */
          border-color: #bfdbfe;
      }

      .grand-total-label,
      .base-total-label {
          font-size: 0.80rem;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          color: var(--text-muted);
      }

      .grand-total-value,
      .base-total-value {
          font-size: 1.8rem;
          font-weight: 800;
          color: #14532d;
      }

      /* PROFIT BOX */
      .profit-metrics {
          background: #f9fafb;
          border-radius: 16px;
          border: 1px solid var(--border-soft);
          padding: 16px 18px;
      }

      /* .profit-field input[readonly] */
      input[readonly] {
          background: #e9ebed;
      }

      /* SMALL SCREEN */
      @media (max-width: 768px) {
          .console-header, .section-header, .section-body {
              padding-left: 18px;
              padding-right: 18px;
          }
          .grand-total-card,
          .base-total-card {
              flex-direction: column;
              align-items: flex-start;
              gap: 6px;
          }
      }

      .console {
        max-width: 100%;
      }
    </style>
</head>
<body>
    <div class="console">
        <!-- HEADER -->
        <div class="console-header">
            <h1 class="console-title">Groot FRP Planters - Pricing Console</h1>
            <div class="status-live">
                <div class="status-dot"></div>
                ðŸŒŸ SEMI-DARK THEME
            </div>
        </div>

        <!-- SECTION 1: Rate Calculator (PERFECT - NO CHANGES) -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">Rate Calculator</h3>
                    <div class="section-subtitle">Rate â†’ Base (+10%) â†’ Final (-15%)</div>
                </div>
                <span class="section-badge">âœ… PERFECT</span>
            </div>
            <div class="section-body">
                <div class="row g-3">
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="rate">Rate (â‚¹)</label>
                        <input type="number" class="form-control" id="rate" placeholder="Enter rate" min="0" step="0.1" />
                    </div>
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="baseAmount">Base Amount (+10%)</label>
                        <input type="number" class="form-control" id="baseAmount" readonly />
                    </div>
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="finalAmount">Final Amount (-15%)</label>
                        <input type="number" class="form-control" id="finalAmount" readonly />
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: KG Pricing Engine (Base Amount Grand Total) -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">KG Pricing Engine</h3>
                    <div class="section-subtitle">Min/Max KG â†’ Average Ã— Finish Rate Ã— Quantity</div>
                </div>
                <span class="section-badge">Section 2</span>
            </div>
            <div class="section-body">
                <div class="row g-3 mb-4">
                    <table class="table items-table">
                        <thead class="text-center">
                            <tr>
                                <th>Min KG</th>
                                <th>Max KG</th>
                                <th>Avg KG</th>
                                <th>Finish Rate</th>
                                <th>Qty</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <input type="number" class="form-control" id="minKg" placeholder="25" min="0" step="0.1" />
                                </td>
                                <td>
                                    <input type="number" class="form-control" id="maxKg" placeholder="40" min="0" step="0.1" />
                                </td>
                                <td>
                                    <input type="number" class="form-control" id="avgKg" readonly step="0.1" />
                                </td>
                                <td>
                                    <select class="form-select" id="finishType">
                                        <option value="200">Basic - â‚¹200/kg</option>
                                        <option value="250">Standard - â‚¹250/kg</option>
                                        <option value="300">Advanced - â‚¹300/kg</option>
                                        <option value="350">Texture - â‚¹350/kg</option>
                                        <option value="375">Rustic - â‚¹375/kg</option>
                                        <option value="500">Matt - â‚¹500/kg</option>
                                        <option value="575">Gloss - â‚¹575/kg</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="form-control" id="kgQty" placeholder="1" min="0" step="1" value="1" />
                                </td>
                                <td>
                                    <button type="button" class="btn-add-remove btn-add" id="addKgRow">+ Add</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <label class="form-label" for="minKg">Min KG</label>
                        <input type="number" class="form-control" id="minKg" placeholder="25" min="0" step="0.1" />
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <label class="form-label" for="maxKg">Max KG</label>
                        <input type="number" class="form-control" id="maxKg" placeholder="40" min="0" step="0.1" />
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <label class="form-label" for="avgKg">Avg KG</label>
                        <input type="number" class="form-control" id="avgKg" readonly step="0.1" />
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <label class="form-label" for="finishType">Finish Rate</label>
                        <select class="form-select" id="finishType">
                            <option value="200">Basic - â‚¹200/kg</option>
                            <option value="250">Standard - â‚¹250/kg</option>
                            <option value="300">Advanced - â‚¹300/kg</option>
                            <option value="350">Texture - â‚¹350/kg</option>
                            <option value="375">Rustic - â‚¹375/kg</option>
                            <option value="500">Matt - â‚¹500/kg</option>
                            <option value="575">Gloss - â‚¹575/kg</option>
                        </select>
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <label class="form-label" for="kgQty">Qty</label>
                        <input type="number" class="form-control" id="kgQty" placeholder="1" min="0" step="1" value="1" />
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
                        <button type="button" class="btn-add-remove btn-add" id="addKgRow">+ Add KG</button>
                    </div> -->
                </div>
                <div class="table-responsive mb-4">
                    <table class="table items-table" id="kgTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Avg KG</th>
                                <th>Finish Rate</th>
                                <th>Qty</th>
                                <th>Base Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="base-total-card">
                    <div>
                        <div class="base-total-label">Base Amount Grand Total</div>
                        <div class="form-label">Section 2 â†’ Flows to Cost Calculation</div>
                    </div>
                    <div class="base-total-value"><span id="kgGrandTotal">0.00</span></div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: Items (SIMPLIFIED: Only Amount, KG, Line Total) -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">Items (Amount Ã— KG)</h3>
                    <div class="section-subtitle">Selling Price = Grand Total of all lines</div>
                </div>
                <span class="section-badge">Section 3</span>
            </div>
            <div class="section-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-label mb-0">Price Ã— QTY = Line Total â†’ Grand Total = Selling Price</div>
                    <button type="button" class="btn-add-remove btn-add" id="addItemRow">+ Add Item</button>
                </div>
                <div class="table-responsive">
                    <table class="table items-table" id="itemsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Price</th>
                                <th>QTY</th>
                                <th>Line Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="grand-total-card">
                    <div>
                        <div class="grand-total-label">Selling Price (Grand Total)</div>
                        <div class="form-label">Selling Price - Base Amount = <span id="yourTotalCostDisplay">0.00</span></div>
                    </div>
                    <div class="grand-total-value"><span id="grandTotal">0.00</span></div>
                </div>
            </div>
        </div>

        <!-- SECTION 4: Profit / Loss -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">Profit / Loss</h3>
                    <div class="section-subtitle">Auto Calculations with Discount</div>
                </div>
                <span class="section-badge">Section 4 - LIVE</span>
            </div>
            <div class="section-body">
                <div class="row g-4 mb-4">
                    <div class="col-6 col-sm-6 col-md-6 col-lg-6 col-xl-6 col-xxl-6">
                        <label class="form-label" for="totalCostInput">Your Total Cost (â‚¹)</label>
                        <input type="number" class="form-control" id="totalCostInput" placeholder="Auto: Selling - Base Amount" readonly />
                    </div>
                    <div class="col-6 col-sm-6 col-md-6 col-lg-6 col-xl-6 col-xxl-6">
                        <label class="form-label" for="discountInput">Additional Discount (â‚¹)</label>
                        <input type="number" class="form-control discount-field" id="discountInput" placeholder="Enter Discount value in (â‚¹)" min="0" step="0.1" value="0" />
                    </div>
                </div>
                <div class="row g-3 profit-metrics">
                    <div class="col-3 col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                        <div class="profit-field">
                            <label class="form-label" for="showBaseTotal">Base Amount Total</label>
                            <input type="number" class="form-control" id="showBaseTotal" readonly />
                        </div>
                    </div>
                    <div class="col-3 col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                        <div class="profit-field">
                            <label class="form-label" for="showTotalSell">Total Selling</label>
                            <input type="number" class="form-control" id="showTotalSell" readonly />
                        </div>
                    </div>
                    <div class="col-3 col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                        <div class="profit-field" id="profitField">
                            <label class="form-label" for="discountedPrice">Discounted Price</label>
                            <input type="number" class="form-control" id="discountedPrice" readonly />
                        </div>
                    </div>
                    <div class="col-3 col-sm-3 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
                        <div class="profit-field" id="percentField">
                            <label class="form-label" for="profitAmount">Profit/Loss (â‚¹)</label>
                            <input type="number" class="form-control" id="profitAmount" readonly />
                        </div>
                    </div>
                </div>
                <div class="row g-3 profit-metrics mt-3">
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12 text-center">
                        <label class="form-label" for="profitPercent">Profit/Loss (%)</label>
                        <input type="text" class="form-control" id="profitPercent" readonly style="font-size: 1.5rem; font-weight: 900;" />
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 5: Export CSV -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">Export Record</h3>
                    <div class="section-subtitle">Save this calculation as CSV</div>
                </div>
                <span class="section-badge">Section 5</span>
            </div>
            <div class="section-body">
                <div class="row g-3 mb-3">
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="partyName">Party Name</label>
                        <input type="text" class="form-control" id="partyName" placeholder="Enter party / customer name" />
                    </div>
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="recordDate">Date</label>
                        <input type="date" class="form-control" id="recordDate" />
                    </div>
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
                        <label class="form-label" for="recordTime">Time</label>
                        <input type="time" class="form-control" id="recordTime" />
                    </div>
                </div>
                <button type="button" class="btn-add-remove btn-add" id="exportCsvBtn">â¬‡ Download CSV</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let itemRowCounter = 0;
        let kgRowCounter = 0;

        // SECTION 1 (PERFECT - NO CHANGES)
        $('#rate').on('input', function() {
            let rate = parseFloat(this.value) || 0;
            if (rate < 0) rate = 0;
            let base = rate * 1.1;
            let final = base * 0.85;
            $('#baseAmount').val(base.toFixed(2));
            $('#finalAmount').val(final.toFixed(2));
        });

        // SECTION 2: KG Pricing Engine
        function calcSingleKG() {
            let min = parseFloat($('#minKg').val()) || 0;
            let max = parseFloat($('#maxKg').val()) || 0;
            let avg = ((min + max) / 2).toFixed(2);
            $('#avgKg').val(avg);
        }

        $('#minKg, #maxKg').on('input', calcSingleKG);

        function addKgRow() {
            kgRowCounter++;
            let avg = $('#avgKg').val() || 0;
            let finishRate = $('#finishType').val() || 300;
            let qty = $('#kgQty').val() || 1;
            let baseAmount = (parseFloat(avg) * parseFloat(finishRate) * parseFloat(qty)).toFixed(2);
            
            let row = $(`
                <tr>
                    <td>${kgRowCounter}</td>
                    <td><input type="number" class="form-control kg-avg" value="${avg}" readonly step="0.01" /></td>
                    <td><input type="number" class="form-control kg-rate" value="${finishRate}" readonly /></td>
                    <td><input type="number" class="form-control kg-qty" value="${qty}" readonly step="1" /></td>
                    <td><input type="number" class="form-control kg-total" value="${baseAmount}" readonly /></td>
                    <td><button class="btn btn-add-remove btn-remove" onclick="removeKgRow(this)">Ã—</button></td>
                </tr>
            `);
            $('#kgTable tbody').append(row);
            calcKgGrandTotal();
        }

        function removeKgRow(btn) {
            $(btn).closest('tr').remove();
            calcKgGrandTotal();
        }

        function calcKgGrandTotal() {
            let grand = 0;
            $('#kgTable tbody tr').each(function() {
                let total = parseFloat($(this).find('.kg-total').val()) || 0;
                grand += total;
            });
            $('#kgGrandTotal').text(grand.toFixed(2));
            calcYourTotalCost();
        }

        $('#addKgRow').click(addKgRow);
        $('#kgQty, #finishType').on('input change', function() {
            calcSingleKG();
            if (kgRowCounter > 0) calcKgGrandTotal();
        });

        // SECTION 3: SIMPLIFIED Items Table
        function addItemRow() {
            itemRowCounter++;
            let row = $(`
                <tr>
                    <td>${itemRowCounter}</td>
                    <td><input type="number" class="form-control item-amount" placeholder="Price" min="500" step="0.1" /></td>
                    <td><input type="number" class="form-control item-qty" placeholder="QTY" min="1" step="1" /></td>
                    <td><input type="number" class="form-control item-total" readonly /></td>
                    <td><button class="btn btn-add-remove btn-remove" onclick="removeItemRow(this)">Ã—</button></td>
                </tr>
            `);
            $('#itemsTable tbody').append(row);
        }

        function removeItemRow(btn) {
            $(btn).closest('tr').remove();
            calcGrandTotal();
        }

        function calcRowTotal(row) {
            let amount = parseFloat(row.find('.item-amount').val()) || 0;
            let qty = parseFloat(row.find('.item-qty').val()) || 0;
            if (amount < 0) amount = 0;
            if (qty < 0) qty = 0;
            let total = amount * qty;
            row.find('.item-total').val(total.toFixed(2));
        }

        function calcGrandTotal() {
            let grand = 0;
            $('#itemsTable tbody tr').each(function() {
                calcRowTotal($(this));
                let total = parseFloat($(this).find('.item-total').val()) || 0;
                grand += total;
            });
            $('#grandTotal').text(grand.toFixed(2));
            calcYourTotalCost();
        }

        $('#itemsTable').on('input', '.item-amount, .item-qty', function() {
            calcRowTotal($(this).closest('tr'));
            calcGrandTotal();
        });

        $('#addItemRow').click(addItemRow);
        addItemRow();

        let baseAmountTotal = 0;
        // CORRECTED FORMULA: Your Total Cost = Selling Price - Base Amount Grand Total
        function calcYourTotalCost() {
            baseAmountTotal = parseFloat($('#kgGrandTotal').text()) || 0;
            let sellingPriceTotal = parseFloat($('#grandTotal').text()) || 0;
            let yourTotalCost = (sellingPriceTotal - baseAmountTotal).toFixed(2);
            
            $('#yourTotalCostDisplay').text(yourTotalCost);
            $('#totalCostInput').val(yourTotalCost);
            $('#showBaseTotal').val(baseAmountTotal.toFixed(2));
            calcProfitLoss();
        }

        // SECTION 4: Profit/Loss with Discount
        function calcProfitLoss() {
            let baseTotal = parseFloat($('#kgGrandTotal').text()) || 0;
            let yourCost = parseFloat($('#totalCostInput').val()) || 0;
            let sell = parseFloat($('#grandTotal').text()) || 0;
            let discount = parseFloat($('#discountInput').val()) || 0;
            
            $('#showTotalSell').val(sell.toFixed(2));
            
            let discountedPrice = sell - discount;
            $('#discountedPrice').val(discountedPrice.toFixed(2));
            
            let profit = (sell - discount - baseAmountTotal);
            $('#profitAmount').val(profit.toFixed(2));
            
            let percent = (baseAmountTotal > 0 ? (profit / baseAmountTotal * 100) : 0);
            $('#profitPercent').val(percent.toFixed(2) + '%');

            let profitField = $('#profitField');
            let percentField = $('#percentField');
            profitField.removeClass('profit-positive profit-negative');
            percentField.removeClass('profit-positive profit-negative');
            
            if (profit >= 0) {
                profitField.addClass('profit-positive');
                percentField.addClass('profit-positive');
                $('#profitPercent').css('color', 'var(--success)');
            } else {
                profitField.addClass('profit-negative');
                percentField.addClass('profit-negative');
                $('#profitPercent').css('color', 'var(--danger)');
            }
        }

        $('#discountInput').on('input', calcProfitLoss);
        calcSingleKG();

        /* ========================== Section 5 | Export Data ========================== */

        // === AUTO SET CURRENT DATE/TIME ON LOAD ===
        $(function () {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');

            const yyyy = now.getFullYear();
            const mm   = pad(now.getMonth() + 1);
            const dd   = pad(now.getDate());
            const hh   = pad(now.getHours());
            const mi   = pad(now.getMinutes());

            $('#recordDate').val(`${yyyy}-${mm}-${dd}`);
            $('#recordTime').val(`${hh}:${mi}`);
        });

        // === CSV EXPORT ===
        function exportToCsv() {
            const partyName = ($('#partyName').val() || '').replace(/,/g, ' ');
            const dateVal   = $('#recordDate').val() || '';
            const timeVal   = $('#recordTime').val() || '';

            const baseTotal       = parseFloat($('#kgGrandTotal').text()) || 0;
            const sellingTotal    = parseFloat($('#grandTotal').text()) || 0;
            const yourTotalCost   = parseFloat($('#yourTotalCostDisplay').text()) || 0;
            const discount        = parseFloat($('#discountInput').val()) || 0;
            const discountedPrice = parseFloat($('#discountedPrice').val()) || 0;
            const profitAmount    = parseFloat($('#profitAmount').val()) || 0;
            const profitPercent   = $('#profitPercent').val() || '0%';

            // CSV header
            let csv = '';
            csv += 'Party Name,Date,Time,Base Amount Total,Selling Price Total,Your Total Cost,Discount,Discounted Price,Profit/Loss Amount,Profit/Loss %\n';

            // Single summary row
            csv += [
                `"${partyName}"`,
                `"${dateVal}"`,
                `"${timeVal}"`,
                baseTotal.toFixed(2),
                sellingTotal.toFixed(2),
                yourTotalCost.toFixed(2),
                discount.toFixed(2),
                discountedPrice.toFixed(2),
                profitAmount.toFixed(2),
                `"${profitPercent}"`
            ].join(',') + '\n';

            // OPTIONAL: add detailed KG rows
            csv += '\n"KG Rows:"\n';
            csv += 'Row,Avg KG,Finish Rate,Qty,Base Amount\n';
            $('#kgTable tbody tr').each(function (index) {
                const avg   = parseFloat($(this).find('.kg-avg').val()) || 0;
                const rate  = parseFloat($(this).find('.kg-rate').val()) || 0;
                const qty   = parseFloat($(this).find('.kg-qty').val()) || 0;
                const total = parseFloat($(this).find('.kg-total').val()) || 0;
                csv += [
                    index + 1,
                    avg.toFixed(2),
                    rate.toFixed(2),
                    qty.toFixed(0),
                    total.toFixed(2)
                ].join(',') + '\n';
            });

            // OPTIONAL: add detailed Item rows
            csv += '\n"Item Rows:"\n';
            csv += 'Row,Price,Qty,Line Total\n';
            $('#itemsTable tbody tr').each(function (index) {
                const price = parseFloat($(this).find('.item-amount').val()) || 0;
                const qty   = parseFloat($(this).find('.item-qty').val()) || 0;
                const total = parseFloat($(this).find('.item-total').val()) || 0;
                csv += [
                    index + 1,
                    price.toFixed(2),
                    qty.toFixed(0),
                    total.toFixed(2)
                ].join(',') + '\n';
            });

            // Download as file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');

            const safeParty = partyName || 'Party';
            const fileName  = `${safeParty.replace(/[^a-zA-Z0-9_-]/g, '')}_${dateVal || 'date'}_${timeVal.replace(':','') || 'time'}.csv`;

            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Button click
        $('#exportCsvBtn').on('click', exportToCsv);
    </script>
</body>
</html>
